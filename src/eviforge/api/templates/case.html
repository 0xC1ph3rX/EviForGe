{% extends "base.html" %}

{% block title %}Case Details - EviForge{% endblock %}

{% block content %}
<div class="layout-grid" style="min-height:auto; display:block;">
    <div class="flex between mb-4">
        <div>
            <div class="text-sm text-muted"> <a href="/web">Dashboard</a> / Case</div>
            <h2 class="mt-1" id="caseTitleDisplay">Loading...</h2>
        </div>
        <div class="flex">
            <span class="badge badge-info" id="caseIdBadge">{{ case_id }}</span>
        </div>
    </div>

    <!-- Tabs Layout -->
    <div class="tabs">
        <div class="tab-btn active" onclick="switchTab('evidence')">Evidence Vault</div>
        <div class="tab-btn" onclick="switchTab('jobs')">Jobs & Modules</div>
        <div class="tab-btn" onclick="switchTab('artifacts')">Artifacts</div>
        <div class="tab-btn" onclick="switchTab('iocs')">IOCs & Findings</div>
    </div>

    <!-- EVIDENCE TAB -->
    <div id="evidence" class="tab-content active">
        <div class="card">
            <div class="flex between mb-4">
                <h3>Evidence Items</h3>
                <div class="flex" style="flex-wrap: wrap; justify-content: flex-end;">
                    <div class="flex" style="gap:0.5rem;">
                        <select id="importFileSelect" title="Files available in /import">
                            <option value="" selected>Loading import files...</option>
                        </select>
                        <input type="text" id="importFilename" placeholder="File in /import (e.g. disk.img)">
                        <button onclick="loadImportFiles()" class="btn btn-outline" type="button">Refresh</button>
                        <button onclick="ingestEvidence()" class="btn btn-primary">Ingest</button>
                    </div>
                    <form id="uploadForm" class="flex" style="gap:0.5rem;" onsubmit="uploadEvidence(event)">
                        <input type="file" id="uploadFile" required>
                        <button type="submit" class="btn btn-outline">Upload</button>
                    </form>
                </div>
            </div>

            <table id="evidenceTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Filename</th>
                        <th>Size</th>
                        <th>Ingested</th>
                        <th>Integrity (SHA256)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="6" class="text-muted text-center">Loading evidence...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- JOBS TAB -->
    <div id="jobs" class="tab-content">
        <div class="card">
            <div class="flex between mb-4">
                <h3>Forensic Modules</h3>
                <div class="flex" style="flex-wrap:wrap;">
                    <select id="moduleSelect">
                        <option value="" selected>Loading modules...</option>
                    </select>
                    <select id="targetEvidenceId" title="Evidence item">
                        <option value="" selected>No evidence loaded</option>
                    </select>
                    <input type="text" id="jobParams" placeholder='Params JSON (optional)' style="min-width:220px;">
                    <button id="runJobBtn" onclick="runJob()" class="btn btn-primary" type="button">Run Module</button>
                    <button id="runPipelineBtn" onclick="runCorePipeline()" class="btn btn-outline" type="button">Run Core Pipeline</button>
                    <button id="refreshModulesBtn" onclick="loadModuleCatalog()" class="btn btn-outline" type="button">Refresh Modules</button>
                </div>
            </div>

            <div id="jobRunStatus" class="text-muted text-sm">Loading module catalog...</div>
            <div id="moduleHelp" class="text-muted text-sm mt-1">Select a module to view requirements.</div>

            <div class="admin-metrics-grid mt-2">
                <div class="metric-tile">
                    <div class="text-xs text-muted uppercase">Total Jobs</div>
                    <div id="caseJobsTotal" class="text-xl font-bold mt-1">0</div>
                </div>
                <div class="metric-tile">
                    <div class="text-xs text-muted uppercase">Running/Pending</div>
                    <div id="caseJobsRunning" class="text-xl font-bold mt-1">0</div>
                </div>
                <div class="metric-tile">
                    <div class="text-xs text-muted uppercase">Completed</div>
                    <div id="caseJobsCompleted" class="text-xl font-bold mt-1">0</div>
                </div>
                <div class="metric-tile">
                    <div class="text-xs text-muted uppercase">Failed</div>
                    <div id="caseJobsFailed" class="text-xl font-bold mt-1">0</div>
                </div>
            </div>

            <div class="ops-chart-card mt-2">
                <h4>Job Status Graph</h4>
                <div id="caseJobStatusGraph" class="metric-bar-list mt-2"></div>
            </div>

            <div class="admin-filters mt-2">
                <input id="jobSearch" type="search" placeholder="Filter jobs by module or error...">
                <select id="jobStatusFilter">
                    <option value="all" selected>All Statuses</option>
                    <option value="PENDING">Pending</option>
                    <option value="RUNNING">Running</option>
                    <option value="COMPLETED">Completed</option>
                    <option value="FAILED">Failed</option>
                </select>
                <span class="badge badge-info">Visible: <span id="caseJobsVisible">0</span></span>
            </div>

            <div class="table-shell mt-2" style="max-height:420px;">
                <table id="jobsTable">
                    <thead>
                        <tr>
                            <th>Module</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Results / Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" class="text-muted text-center">Loading jobs...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ARTIFACTS TAB -->
    <div id="artifacts" class="tab-content">
        <div class="card">
            <div class="flex between mb-4">
                <div>
                    <h3>Artifacts Browser</h3>
                    <div class="text-muted text-sm">Browse module outputs under the case vault (read-only).</div>
                </div>
                <div class="flex" style="gap:0.5rem;">
                    <button class="btn btn-sm btn-outline" type="button" onclick="artifactsUp()">Up</button>
                    <span class="badge badge-info text-mono" id="artifactsPath">/</span>
                </div>
            </div>

            <div class="artifact-browser">
                <div class="artifact-tree">
                    <div class="text-muted text-sm mb-2">Folders / Files</div>
                    <div id="artifactTree" class="artifact-list">Loading…</div>
                </div>
                <div class="artifact-preview">
                    <div class="text-muted text-sm mb-2">Preview</div>
                    <div id="artifactPreview" class="pre-block">Select a file to preview.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- IOCS TAB -->
    <div id="iocs" class="tab-content">
        <div class="layout-grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem; display:grid;">
            <!-- Findings (Left) -->
            <div class="card">
                <h3>System Findings</h3>
                <div id="findingsList" style="display:flex; flex-direction:column; gap:0.5rem;">
                    <div class="text-muted text-center p-4">Loading matches...</div>
                </div>
            </div>

            <!-- IOC Management (Right) -->
            <div class="card">
                <div class="flex between mb-4">
                    <h3>IOC Watchlist</h3>
                </div>
                <div class="flex mb-4">
                    <select id="iocType" style="width:100px;">
                        <option value="ip">IP</option>
                        <option value="domain">Domain</option>
                        <option value="md5">MD5</option>
                    </select>
                    <input type="text" id="iocValue" placeholder="Value (e.g. 1.2.3.4)" style="flex-grow:1;">
                    <button onclick="addIOC()" class="btn btn-outline">Add</button>
                </div>

                <table id="iocListTable">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Value</th>
                            <th>Con.</th>
                            <th>Added</th>
                        </tr>
                    </thead>
                    <tbody id="iocList">
                        <tr>
                            <td colspan="4" class="text-muted text-center">No IOCs.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>



</div>
{% endblock %}

{% block scripts %}
<script>
    const CASE_ID = "{{ case_id }}";
    let EVIDENCE_ITEMS = [];
    let CURRENT_ARTIFACTS_PATH = "";
    const MODULE_REQUIREMENTS = new Map();
    let MODULE_CATALOG = [];
    let CASE_JOBS = [];

    function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, (c) => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        }[c]));
    }

    function setJobRunStatus(msg, isError = false) {
        const el = document.getElementById('jobRunStatus');
        if (!el) return;
        el.textContent = msg || '';
        el.className = isError ? 'text-danger text-sm' : 'text-muted text-sm';
    }

    async function responseErrorText(res) {
        try {
            const data = await res.json();
            if (typeof data?.detail === 'string') return data.detail;
            if (data?.detail) return JSON.stringify(data.detail);
            return JSON.stringify(data);
        } catch (_) {
            try { return await res.text(); } catch (_) { return 'Unknown error'; }
        }
    }

    function moduleRequiresEvidence(moduleName) {
        return MODULE_REQUIREMENTS.has(moduleName)
            ? !!MODULE_REQUIREMENTS.get(moduleName)
            : true;
    }

    function updateJobMetrics(items) {
        const rows = items || [];
        const total = rows.length;
        const running = rows.filter((j) => j.status === 'RUNNING' || j.status === 'PENDING').length;
        const completed = rows.filter((j) => j.status === 'COMPLETED').length;
        const failed = rows.filter((j) => j.status === 'FAILED').length;

        const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = String(value);
        };
        setText('caseJobsTotal', total);
        setText('caseJobsRunning', running);
        setText('caseJobsCompleted', completed);
        setText('caseJobsFailed', failed);

        renderMetricBars('caseJobStatusGraph', [
            { label: 'Pending', count: rows.filter((j) => j.status === 'PENDING').length, tone: 'metric-bar-warning' },
            { label: 'Running', count: rows.filter((j) => j.status === 'RUNNING').length, tone: 'metric-bar-info' },
            { label: 'Completed', count: completed, tone: 'metric-bar-success' },
            { label: 'Failed', count: failed, tone: 'metric-bar-danger' },
        ], 'No jobs to chart yet.');
    }

    function renderMetricBars(containerId, rows, emptyText) {
        const el = document.getElementById(containerId);
        if (!el) return;
        if (!rows || !rows.length) {
            el.innerHTML = `<div class="text-muted text-sm">${escapeHtml(emptyText || 'No data')}</div>`;
            return;
        }
        const max = Math.max(...rows.map((r) => Number(r.count) || 0), 1);
        el.innerHTML = rows.map((row) => {
            const count = Number(row.count) || 0;
            const width = count <= 0 ? 4 : Math.max(8, Math.round((count / max) * 100));
            return `<div class="metric-bar-row">
                <span class="text-sm text-muted">${escapeHtml(row.label)}</span>
                <div class="metric-bar-track"><div class="metric-bar-fill ${escapeHtml(row.tone || '')}" style="width:${width}%"></div></div>
                <span class="text-mono text-sm">${count}</span>
            </div>`;
        }).join('');
    }

    function jobMatchesFilter(job) {
        const q = (document.getElementById('jobSearch')?.value || '').trim().toLowerCase();
        const status = (document.getElementById('jobStatusFilter')?.value || 'all');
        if (status !== 'all' && String(job.status) !== status) return false;
        if (!q) return true;
        const text = [job.module, job.status, job.error].map((v) => String(v || '').toLowerCase()).join(' ');
        return text.includes(q);
    }

    function renderJobsTable(items) {
        const tbody = document.querySelector('#jobsTable tbody');
        if (!tbody) return;
        const filtered = (items || []).filter(jobMatchesFilter);
        const visibleEl = document.getElementById('caseJobsVisible');
        if (visibleEl) visibleEl.textContent = String(filtered.length);

        if (!filtered.length) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No jobs match the current filter.</td></tr>';
            return;
        }

        function artifactUrl(p) {
            const parts = String(p).split('/').map(encodeURIComponent).join('/');
            return `/api/artifacts/${CASE_ID}/${parts}`;
        }

        tbody.innerHTML = filtered.map(job => {
            let statusBadge = `<span class="badge badge-info">${escapeHtml(job.status)}</span>`;
            if (job.status === 'COMPLETED') statusBadge = `<span class="badge badge-success">Completed</span>`;
            if (job.status === 'FAILED') statusBadge = `<span class="badge badge-danger">Failed</span>`;
            if (job.status === 'RUNNING') statusBadge = `<span class="badge badge-warning">Running</span>`;

            let actions = '<span class="text-muted text-sm">-</span>';
            if (job.output_files && job.output_files.length > 0) {
                actions = job.output_files.map(p => `<a href="${artifactUrl(p)}" target="_blank" class="text-sm">Download</a>`).join('<br>');
            } else if (job.status === 'FAILED') {
                actions = `<span class="text-danger text-sm" title="${escapeHtml(job.error || 'Unknown Error')}">Failed</span>`;
            }
            actions = `<a class="text-sm" href="/web/jobs/${job.id}">View Job</a><br>` + actions;

            return `
                <tr>
                    <td style="font-weight:500;">${escapeHtml(job.module)}</td>
                    <td>${statusBadge}</td>
                    <td class="text-sm text-muted">${new Date(job.created_at).toLocaleString()}</td>
                    <td>${actions}</td>
                </tr>
            `;
        }).join('');
    }

    function renderModuleCatalog(modules) {
        const select = document.getElementById('moduleSelect');
        if (!select) return;
        const current = select.value || '';
        if (!modules.length) {
            select.innerHTML = '<option value="" selected>No modules available</option>';
            MODULE_REQUIREMENTS.clear();
            setJobRunStatus('No modules available in current runtime.', true);
            return;
        }
        MODULE_REQUIREMENTS.clear();
        select.innerHTML = ['<option value="" selected>Select Module...</option>']
            .concat(modules.map((m) => {
                const name = String(m.name || '');
                const desc = String(m.description || '');
                const req = !!m.requires_evidence;
                const avail = !!m.available;
                MODULE_REQUIREMENTS.set(name, req);
                const evidenceLabel = req ? 'evidence' : 'case';
                const prefix = avail ? '' : '[unavailable] ';
                return `<option value="${escapeHtml(name)}" ${avail ? '' : 'disabled'}>${escapeHtml(prefix + name + ' - ' + evidenceLabel + ' - ' + desc.slice(0, 48))}</option>`;
            }))
            .join('');
        if (current && modules.some((m) => m.name === current && m.available)) {
            select.value = current;
        }
        onModuleSelectionChanged();
        setJobRunStatus(`Loaded ${modules.filter((m) => m.available).length}/${modules.length} modules.`);
    }

    function onModuleSelectionChanged() {
        const module = document.getElementById('moduleSelect')?.value || '';
        const evSel = document.getElementById('targetEvidenceId');
        const help = document.getElementById('moduleHelp');
        if (evSel) evSel.disabled = !module || !moduleRequiresEvidence(module);
        const meta = MODULE_CATALOG.find((m) => String(m.name) === module);
        if (!help) return;
        if (!module) {
            help.textContent = 'Select a module to view requirements.';
            help.className = 'text-muted text-sm mt-1';
            return;
        }
        const reqText = moduleRequiresEvidence(module) ? 'Requires evidence selection.' : 'Runs on case scope.';
        const availText = meta && !meta.available ? 'Module unavailable in this runtime.' : 'Module available.';
        const desc = String(meta?.description || '');
        help.textContent = `${reqText} ${availText} ${desc}`;
        help.className = (meta && !meta.available) ? 'text-danger text-sm mt-1' : 'text-muted text-sm mt-1';
    }

    async function loadModuleCatalog() {
        const select = document.getElementById('moduleSelect');
        if (select) select.innerHTML = '<option value="" selected>Loading modules...</option>';
        setJobRunStatus('Loading module catalog...');
        const res = await apiFetch('/api/modules/catalog');
        if (!res.ok) {
            setJobRunStatus(`Failed to load module catalog (${res.status})`, true);
            return;
        }
        const data = await res.json();
        MODULE_CATALOG = data.modules || [];
        renderModuleCatalog(MODULE_CATALOG);
    }

    // Tab Logic
    function switchTab(tabId) {
        // Toggle Buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('onclick').includes(tabId));
        });
        // Toggle Content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
            if (content.id === tabId) content.classList.add('active');
        });

        // Lazy Load
        if (tabId === 'evidence') loadEvidence();
        if (tabId === 'jobs') loadJobs();
        if (tabId === 'artifacts') loadArtifacts();
        if (tabId === 'iocs') { loadIOCs(); loadMatches(); }
    }

    // --- DATA LOADING ---
    async function loadData() {
        try {
            const caseRes = await apiFetch(`/api/cases/${CASE_ID}`);
            if (caseRes.ok) {
                const c = await caseRes.json();
                document.getElementById('caseTitleDisplay').innerText = c.name;
                // document.title = `Case ${c.name} - EviForge`;
            }
            loadImportFiles();
            loadEvidence();
            loadModuleCatalog();
            loadJobs();
        } catch (e) { console.error(e); }
    }

    // --- EVIDENCE ---
    async function loadEvidence() {
        const res = await apiFetch(`/api/cases/${CASE_ID}/evidence`);
        const tbody = document.querySelector('#evidenceTable tbody');
        if (!res.ok) return;

        const items = await res.json();
        EVIDENCE_ITEMS = items;
        refreshEvidenceSelect(items);
        if (items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No evidence ingested yet.</td></tr>';
            return;
        }

        tbody.innerHTML = items.map(ev => `
            <tr>
                <td class="text-mono text-sm text-muted">${ev.id.substring(0, 8)}</td>
                <td style="font-weight:500;">${escapeHtml(ev.filename)}</td>
                <td class="text-sm">${(ev.size / 1024).toFixed(2)} KB</td>
                <td class="text-sm text-muted">${new Date(ev.ingested_at).toLocaleString()}</td>
                <td class="text-mono text-xs">
                    ${ev.hashes.sha256 ? ev.hashes.sha256.substring(0, 16) + "..." : '<span class="badge badge-warning">Pending</span>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline" type="button" onclick="copyText('${ev.id}')">Copy ID</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadImportFiles() {
        const sel = document.getElementById('importFileSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="" selected>Loading import files...</option>';

        const res = await apiFetch(`/api/cases/${CASE_ID}/import-files`);
        if (!res.ok) {
            sel.innerHTML = '<option value="" selected>Failed to load import files</option>';
            return;
        }
        const data = await res.json();
        const files = data.files || [];
        if (files.length === 0) {
            sel.innerHTML = '<option value="" selected>No files in import directory</option>';
            return;
        }
        sel.innerHTML = ['<option value="" selected>Select file from import…</option>']
            .concat(files.map(f => `<option value="${escapeHtml(f.name)}">${escapeHtml(f.name)} (${(f.size / 1024).toFixed(1)} KB)</option>`))
            .join('');
    }

    async function ingestEvidence() {
        const selected = document.getElementById('importFileSelect')?.value || '';
        const typed = document.getElementById('importFilename').value.trim();
        const filename = typed || selected;
        if (!filename) return alert("Enter a filename");
        const res = await apiFetch(`/api/cases/${CASE_ID}/evidence`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename })
        });
        if (res.ok) {
            document.getElementById('importFilename').value = '';
            if (document.getElementById('importFileSelect')) {
                document.getElementById('importFileSelect').value = '';
            }
            loadImportFiles();
            loadEvidence();
        }
        else alert('Ingest failed');
    }

    async function uploadEvidence(e) {
        e.preventDefault();
        const fileInput = document.getElementById('uploadFile');
        if (!fileInput.files || !fileInput.files.length) return;
        const fd = new FormData();
        fd.append('file', fileInput.files[0]);
        const res = await apiFetch(`/api/cases/${CASE_ID}/evidence/upload`, { method: 'POST', body: fd });
        if (res.ok) { fileInput.value = ''; loadEvidence(); }
        else alert('Upload failed');
    }

    function refreshEvidenceSelect(items) {
        const sel = document.getElementById('targetEvidenceId');
        if (!sel) return;
        if (!items || items.length === 0) {
            sel.innerHTML = '<option value="" selected>No evidence loaded</option>';
            return;
        }
        sel.innerHTML = ['<option value="" selected>Select evidence…</option>'].concat(
            items.map(ev => `<option value="${ev.id}">${ev.filename} (${ev.id.substring(0, 8)})</option>`)
        ).join('');
        onModuleSelectionChanged();
    }

    // --- JOBS ---
    async function loadJobs() {
        const res = await apiFetch(`/api/cases/${CASE_ID}/jobs`);
        if (!res.ok) {
            setJobRunStatus(`Failed to load jobs (${res.status})`, true);
            return;
        }

        CASE_JOBS = await res.json();
        updateJobMetrics(CASE_JOBS);
        renderJobsTable(CASE_JOBS);
        setJobRunStatus(`Loaded ${CASE_JOBS.length} jobs.`);
    }

    async function submitModuleJob(moduleName, evidenceId, params = {}) {
        const res = await apiFetch(`/api/cases/${CASE_ID}/jobs`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ module: moduleName, evidence_id: evidenceId || null, params })
        });
        if (!res.ok) {
            return {
                ok: false,
                status: res.status,
                error: await responseErrorText(res),
            };
        }
        const data = await res.json();
        return { ok: true, data };
    }

    async function runJob() {
        const module = document.getElementById('moduleSelect').value;
        const evidenceId = document.getElementById('targetEvidenceId').value;
        const paramsRaw = (document.getElementById('jobParams')?.value || '').trim();
        const runBtn = document.getElementById('runJobBtn');
        if (!module) {
            setJobRunStatus('Select a module first.', true);
            return;
        }
        if (moduleRequiresEvidence(module) && !evidenceId) {
            setJobRunStatus('Selected module requires evidence. Choose evidence first.', true);
            return;
        }

        let params = {};
        if (paramsRaw) {
            try { params = JSON.parse(paramsRaw); }
            catch {
                setJobRunStatus('Params JSON is invalid.', true);
                return;
            }
        }

        if (runBtn) runBtn.disabled = true;
        setJobRunStatus(`Submitting module ${module}...`);

        const result = await submitModuleJob(module, evidenceId || null, params);
        if (runBtn) runBtn.disabled = false;
        if (result.ok) {
            const data = result.data;
            setJobRunStatus(`Module ${module} queued as job ${String(data.id || '').substring(0, 8)}.`);
            loadJobs();
            switchTab('jobs');
        } else {
            setJobRunStatus(`Run failed (${result.status}): ${result.error}`, true);
        }
    }

    async function runCorePipeline() {
        const runBtn = document.getElementById('runJobBtn');
        const pipelineBtn = document.getElementById('runPipelineBtn');
        const evidenceId = document.getElementById('targetEvidenceId').value;
        const availableNames = new Set((MODULE_CATALOG || []).filter((m) => !!m.available).map((m) => String(m.name)));
        const pipelineOrder = ['inventory', 'verify', 'strings', 'timeline', 'triage', 'yara', 'pcap', 'report'];
        const selectedModules = pipelineOrder.filter((name) => availableNames.has(name));

        if (!selectedModules.length) {
            setJobRunStatus('No core modules are available in this runtime.', true);
            return;
        }
        const needsEvidence = selectedModules.some((name) => moduleRequiresEvidence(name));
        if (needsEvidence && !evidenceId) {
            setJobRunStatus('Core pipeline requires evidence. Select evidence first.', true);
            return;
        }

        if (runBtn) runBtn.disabled = true;
        if (pipelineBtn) pipelineBtn.disabled = true;

        let okCount = 0;
        let failCount = 0;
        for (let idx = 0; idx < selectedModules.length; idx += 1) {
            const name = selectedModules[idx];
            setJobRunStatus(`Core pipeline: ${name} (${idx + 1}/${selectedModules.length})...`);
            const result = await submitModuleJob(name, moduleRequiresEvidence(name) ? evidenceId : null, {});
            if (result.ok) okCount += 1;
            else failCount += 1;
        }

        if (runBtn) runBtn.disabled = false;
        if (pipelineBtn) pipelineBtn.disabled = false;

        await loadJobs();
        if (failCount > 0) {
            setJobRunStatus(`Core pipeline finished with errors. Success: ${okCount}, Failed: ${failCount}.`, true);
        } else {
            setJobRunStatus(`Core pipeline queued successfully (${okCount} modules).`);
        }
    }

    document.getElementById('moduleSelect')?.addEventListener('change', () => {
        onModuleSelectionChanged();
    });

    document.getElementById('jobSearch')?.addEventListener('input', () => renderJobsTable(CASE_JOBS));
    document.getElementById('jobStatusFilter')?.addEventListener('change', () => renderJobsTable(CASE_JOBS));

    document.getElementById('importFileSelect')?.addEventListener('change', () => {
        const sel = document.getElementById('importFileSelect');
        const input = document.getElementById('importFilename');
        if (!sel || !input) return;
        if (sel.value) input.value = sel.value;
    });

    // --- ARTIFACTS ---
    function setArtifactsPath(p) {
        CURRENT_ARTIFACTS_PATH = p || "";
        const badge = document.getElementById('artifactsPath');
        if (badge) badge.textContent = CURRENT_ARTIFACTS_PATH ? `/${CURRENT_ARTIFACTS_PATH}` : '/';
    }

    async function loadArtifacts(path = CURRENT_ARTIFACTS_PATH) {
        setArtifactsPath(path);
        const tree = document.getElementById('artifactTree');
        if (!tree) return;
        tree.textContent = 'Loading…';
        const qs = path ? `?path=${encodeURIComponent(path)}` : '';
        const res = await apiFetch(`/api/cases/${CASE_ID}/artifacts/tree${qs}`);
        if (!res.ok) { tree.textContent = `Failed to load (${res.status})`; return; }
        const data = await res.json();
        const items = data.items || [];
        if (!items.length) { tree.innerHTML = '<div class="text-muted text-sm">Empty folder.</div>'; return; }

        tree.innerHTML = '';
        for (const it of items) {
            const row = document.createElement('div');
            row.className = 'artifact-item';

            const icon = document.createElement('span');
            icon.className = 'artifact-icon text-mono';
            icon.textContent = (it.type === 'dir') ? '[DIR]' : '[FILE]';

            const name = document.createElement('span');
            name.textContent = ` ${it.name}`;

            row.appendChild(icon);
            row.appendChild(name);

            row.addEventListener('click', () => {
                if (it.type === 'dir') openArtifactDir(it.path);
                else openArtifactFile(it.path);
            });

            tree.appendChild(row);
        }
    }

    function openArtifactDir(p) {
        loadArtifacts(p);
    }

    async function openArtifactFile(p) {
        const pre = document.getElementById('artifactPreview');
        if (!pre) return;
        pre.textContent = 'Loading…';
        const res = await apiFetch(`/api/cases/${CASE_ID}/artifacts/file?path=${encodeURIComponent(p)}`);
        if (!res.ok) { pre.textContent = `Failed to preview (${res.status})`; return; }
        const data = await res.json();
        if (data.kind === 'json' || data.kind === 'jsonl') {
            pre.textContent = JSON.stringify(data.data, null, 2);
        } else if (data.kind === 'csv') {
            pre.textContent = (data.rows || []).map(r => r.join(',')).join('\n');
        } else if (data.kind === 'binary' || data.kind === 'too_large') {
            pre.innerHTML = `<div class="text-muted">Preview unavailable (${escapeHtml(data.kind)}).</div><div class="mt-1"><a href="${escapeHtml(data.download_url)}" target="_blank">Download</a></div>`;
        } else {
            pre.textContent = data.text || '';
        }
    }

    function artifactsUp() {
        if (!CURRENT_ARTIFACTS_PATH) return loadArtifacts('');
        const parts = CURRENT_ARTIFACTS_PATH.split('/').filter(Boolean);
        parts.pop();
        loadArtifacts(parts.join('/'));
    }

    function copyText(s) {
        try {
            navigator.clipboard.writeText(s);
        } catch {
            // fallback
            const ta = document.createElement('textarea');
            ta.value = s;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
        }
    }

    // --- IOCS ---
    async function loadIOCs() {
        const res = await apiFetch(`/api/cases/${CASE_ID}/iocs/`);
        const tbody = document.getElementById('iocList');
        if (!res.ok) return;
        const iocs = await res.json();

        if (iocs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-muted text-center">No IOCs.</td></tr>';
            return;
        }
        tbody.innerHTML = iocs.map(i => `
            <tr>
                <td><span class="badge badge-info">${i.type}</span></td>
                <td class="text-mono text-sm">${i.value}</td>
                <td class="text-sm">${i.confidence}</td>
                <td class="text-sm text-muted">${new Date(i.created_at).toLocaleDateString()}</td>
            </tr>
        `).join('');
    }

    async function loadMatches() {
        const res = await apiFetch(`/api/cases/${CASE_ID}/iocs/matches`);
        const div = document.getElementById('findingsList');
        if (!res.ok) return;
        const matches = await res.json();

        if (matches.length === 0) {
            div.innerHTML = '<div class="text-muted text-center p-4">No system findings yet.</div>';
            return;
        }

        div.innerHTML = matches.map(m => `
            <div class="card" style="margin-bottom:0.5rem; padding:1rem; border-left:4px solid var(--danger);">
                <div class="flex between">
                    <strong>Match: ${m.ioc_value}</strong>
                    <span class="badge badge-danger">IOC HIT</span>
                </div>
                <div class="text-sm mt-1">Found in: <span class="text-mono">${m.evidence_id || '?'}</span></div>
                 <div class="text-xs text-muted mt-1">${new Date(m.created_at).toLocaleString()}</div>
            </div>
        `).join('');
    }

    async function addIOC() {
        const type = document.getElementById('iocType').value;
        const value = document.getElementById('iocValue').value;
        if (!value) return;
        await apiFetch(`/api/cases/${CASE_ID}/iocs/`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type, value, confidence: 'high' })
        });
        document.getElementById('iocValue').value = '';
        loadIOCs();
    }

    // Init
    loadData();
    // Poll Jobs
    setInterval(() => {
        if (document.getElementById('jobs').classList.contains('active')) loadJobs();
    }, 5000);

</script>
{% endblock %}
